<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR с камерой</title>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: Arial, sans-serif; 
            overflow: hidden;
        }
        #ar-button { 
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            padding: 15px 30px; 
            font-size: 18px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        #ar-container { 
            position: relative; 
            width: 100vw; 
            height: 100vh; 
        }
        #camera-view { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            display: none;
        }
        #model-container { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
        }
        #status {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="ar-container">
        <video id="camera-view" autoplay playsinline></video>
        <div id="model-container"></div>
        <div id="status">Загрузка...</div>
    </div>
    <button id="ar-button">Запустить AR с камерой</button>

    <!-- Подключаем Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    
    <script>
        // Глобальные переменные
        let scene, camera, renderer, model;
        let video, videoTexture;
        let isInitialized = false;

        // Инициализация Three.js сцены
        function initThreeJS() {
            try {
                scene = new THREE.Scene();
                
                // Камера Three.js
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 0, 5);
                
                // Рендерер
                renderer = new THREE.WebGLRenderer({ 
                    alpha: true,
                    antialias: true 
                });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setClearColor(0x000000, 0);
                document.getElementById('model-container').appendChild(renderer.domElement);
                
                // Добавляем свет
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 10, 5);
                scene.add(directionalLight);
                
                isInitialized = true;
                console.log('Three.js инициализирован');
                
            } catch (error) {
                console.error('Ошибка инициализации Three.js:', error);
                updateStatus('Ошибка инициализации 3D');
            }
        }

        // Загрузка 3D модели
        function loadModel(modelUrl) {
            updateStatus('Загрузка 3D модели...');
            
            const loader = new THREE.GLTFLoader();
            
            loader.load(modelUrl, 
                // onLoad
                function(gltf) {
                    model = gltf.scene;
                    model.scale.set(1, 1, 1);
                    model.position.set(0, 0, -3);
                    scene.add(model);
                    updateStatus('Модель загружена');
                    
                    // Запускаем анимацию
                    animate();
                }, 
                // onProgress
                function(xhr) {
                    const percent = (xhr.loaded / xhr.total * 100).toFixed(2);
                    updateStatus(`Загрузка модели: ${percent}%`);
                },
                // onError
                function(error) {
                    console.error('Ошибка загрузки модели:', error);
                    updateStatus('Ошибка загрузки модели');
                }
            );
        }

        // Запуск камеры устройства
        async function startCamera() {
            try {
                updateStatus('Запрос доступа к камере...');
                video = document.getElementById('camera-view');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                video.srcObject = stream;
                video.style.display = 'block';
                
                // Ждем загрузки видео
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });
                
                updateStatus('Камера активирована');
                
            } catch (error) {
                console.error('Ошибка доступа к камере:', error);
                updateStatus('Ошибка доступа к камере');
                
                // Пробуем использовать фронтальную камеру как запасной вариант
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: true 
                    });
                    video.srcObject = stream;
                    video.style.display = 'block';
                    updateStatus('Используется фронтальная камера');
                } catch (fallbackError) {
                    console.error('Не удалось получить доступ ни к одной камере:', fallbackError);
                    alert('Не удалось получить доступ к камере. Проверьте разрешения.');
                }
            }
        }

        // Обновление статуса
        function updateStatus(message) {
            const statusElement = document.getElementById('status');
            statusElement.style.display = 'block';
            statusElement.textContent = message;
            
            // Автоматически скрываем сообщение через 3 секунды
            if (message.includes('загружена') || message.includes('активирована')) {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }

        // Анимационный цикл
        function animate() {
            if (!isInitialized) return;
            
            requestAnimationFrame(animate);
            
            if (model) {
                model.rotation.y += 0.01;
            }
            
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        // Основная функция инициализации
        async function initAR() {
            const button = document.getElementById('ar-button');
            button.disabled = true;
            button.textContent = 'Загрузка...';
            
            updateStatus('Инициализация AR...');
            
            try {
                // Инициализируем Three.js
                initThreeJS();
                
                // Запускаем камеру
                await startCamera();
                
                // Загружаем модель (можно заменить на вашу модель)
                const modelUrl = 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF/Duck.gltf';
                loadModel(modelUrl);
                
                // Скрываем кнопку после успешного запуска
                setTimeout(() => {
                    button.style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('Ошибка инициализации AR:', error);
                updateStatus('Ошибка инициализации AR');
                button.disabled = false;
                button.textContent = 'Попробовать снова';
            }
        }

        // Обработчик изменения размера окна
        function handleResize() {
            if (!camera || !renderer) return;
            
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Добавляем обработчики событий
            document.getElementById('ar-button').addEventListener('click', initAR);
            window.addEventListener('resize', handleResize);
            
            // Проверяем поддержку API
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                updateStatus('Ваш браузер не поддерживает доступ к камере');
            }
            
            console.log('Страница загружена, готов к работе');
        });

        // Обработка ошибок
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            updateStatus('Произошла ошибка: ' + e.error.message);
        });
    </script>
</body>
</html>